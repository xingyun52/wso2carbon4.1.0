CREATE EXTERNAL TABLE IF NOT EXISTS mappingJmxDataTable (key STRING, heap_mem_committed BIGINT, heap_mem_init BIGINT, heap_mem_max BIGINT, heap_mem_used BIGINT,non_heap_mem_committed BIGINT, non_heap_mem_init BIGINT, non_heap_mem_max BIGINT, non_heap_mem_used BIGINT,processCpuTime BIGINT, ps_eden_space_committed BIGINT, ps_eden_space_init BIGINT, ps_eden_space_max BIGINT, ps_eden_space_used BIGINT, ps_perm_gen_committed BIGINT, ps_perm_gen_init BIGINT, ps_perm_gen_max BIGINT, ps_perm_gen_used BIGINT, payload_timestamp BIGINT, host STRING) STORED BY
'org.apache.hadoop.hive.cassandra.CassandraStorageHandler' WITH SERDEPROPERTIES ( "cassandra.host" = "127.0.0.1",
"cassandra.port" = "9160","cassandra.ks.name" = "EVENT_KS",
"cassandra.ks.username" = "admin","cassandra.ks.password" = "admin",
"cassandra.cf.name" = "org_wso2_bam_jmx_agent_toolbox",
"cassandra.columns.mapping" = ":key,payload_heap_mem_committed, payload_heap_mem_init, payload_heap_mem_max,payload_heap_mem_used,payload_non_heap_mem_committed, payload_non_heap_mem_init, payload_non_heap_mem_max,payload_non_heap_mem_used,payload_processCpuTime,payload_ps_eden_space_committed,payload_ps_eden_space_init,payload_ps_eden_space_max,payload_ps_eden_space_used, payload_ps_perm_gen_committed,payload_ps_perm_gen_init,payload_ps_perm_gen_max,payload_ps_perm_gen_used,Timestamp,meta_host" );

CREATE EXTERNAL TABLE IF NOT EXISTS targetJmxDataTable (host STRING, heap_mem_committed BIGINT, heap_mem_init BIGINT, heap_mem_max BIGINT, heap_mem_used BIGINT,non_heap_mem_committed BIGINT, non_heap_mem_init BIGINT, non_heap_mem_max BIGINT, non_heap_mem_used BIGINT,processCpuTime BIGINT, ps_eden_space_committed BIGINT, ps_eden_space_init BIGINT, ps_eden_space_max BIGINT, ps_eden_space_used BIGINT, ps_perm_gen_committed BIGINT, ps_perm_gen_init BIGINT, ps_perm_gen_max BIGINT, ps_perm_gen_used BIGINT, time STRING)
STORED BY 'org.wso2.carbon.hadoop.hive.jdbc.storage.JDBCStorageHandler' TBLPROPERTIES (
'wso2.carbon.datasource.name'='WSO2BAM_DATASOURCE',
'hive.jdbc.update.on.duplicate' = 'true',
'hive.jdbc.primary.key.fields' = 'host,time',
'hive.jdbc.table.create.query' = 'CREATE TABLE JMX_DATA_TABLE ( host VARCHAR(100) NOT NULL, heap_mem_committed BIGINT, heap_mem_init BIGINT, heap_mem_max BIGINT, heap_mem_used BIGINT,non_heap_mem_committed BIGINT, non_heap_mem_init BIGINT, non_heap_mem_max BIGINT, non_heap_mem_used BIGINT,processCpuTime BIGINT, ps_eden_space_committed BIGINT, ps_eden_space_init BIGINT, ps_eden_space_max BIGINT, ps_eden_space_used BIGINT, ps_perm_gen_committed BIGINT, ps_perm_gen_init BIGINT, ps_perm_gen_max BIGINT, ps_perm_gen_used BIGINT,time VARCHAR(30))' );
                             
insert overwrite table targetJmxDataTable select host, heap_mem_committed, heap_mem_init, heap_mem_max, heap_mem_used,non_heap_mem_committed, non_heap_mem_init , non_heap_mem_max , non_heap_mem_used ,processCpuTime, ps_eden_space_committed, ps_eden_space_init, ps_eden_space_max, ps_eden_space_used, ps_perm_gen_committed, ps_perm_gen_init, ps_perm_gen_max, ps_perm_gen_used, from_unixtime(cast(payload_timestamp/1000 as BIGINT) ) from mappingJmxDataTable;

CREATE EXTERNAL TABLE IF NOT EXISTS JmxStatsPerMinute (host STRING, avg_heap_mem_committed BIGINT, avg_heap_mem_init BIGINT, avg_heap_mem_max BIGINT, avg_heap_mem_used BIGINT, avg_non_heap_mem_committed BIGINT, avg_non_heap_mem_init BIGINT, avg_non_heap_mem_max BIGINT, avg_non_heap_mem_used BIGINT, avg_processCpuTime BIGINT, avg_ps_eden_space_committed BIGINT, avg_ps_eden_space_init BIGINT, avg_ps_eden_space_max BIGINT, avg_ps_eden_space_used BIGINT, avg_ps_perm_gen_committed BIGINT, avg_ps_perm_gen_init BIGINT, avg_ps_perm_gen_max BIGINT, avg_ps_perm_gen_used BIGINT, year SMALLINT, month SMALLINT, day SMALLINT, hour SMALLINT, minute SMALLINT, time STRING)
STORED BY 'org.wso2.carbon.hadoop.hive.jdbc.storage.JDBCStorageHandler' TBLPROPERTIES ( 
'wso2.carbon.datasource.name'='WSO2BAM_DATASOURCE',
'hive.jdbc.update.on.duplicate' = 'true',
'hive.jdbc.primary.key.fields' = 'year,month,day,hour,minute',
'hive.jdbc.table.create.query' = 'CREATE TABLE JMX_SUMMARY_PER_MINUTE (host VARCHAR(100) NOT NULL, avg_heap_mem_committed BIGINT, avg_heap_mem_init BIGINT, avg_heap_mem_max BIGINT, avg_heap_mem_used BIGINT, avg_non_heap_mem_committed BIGINT, avg_non_heap_mem_init BIGINT, avg_non_heap_mem_max BIGINT, avg_non_heap_mem_used BIGINT, avg_processCpuTime BIGINT, avg_ps_eden_space_committed BIGINT, avg_ps_eden_space_init BIGINT, avg_ps_eden_space_max BIGINT, avg_ps_eden_space_used BIGINT, avg_ps_perm_gen_committed BIGINT, avg_ps_perm_gen_init BIGINT, avg_ps_perm_gen_max BIGINT, avg_ps_perm_gen_used BIGINT, year SMALLINT, month SMALLINT, day SMALLINT, hour SMALLINT, minute SMALLINT, time VARCHAR(30))' );

insert overwrite table JmxStatsPerMinute select host, avg(heap_mem_committed) as avg_heap_mem_committed, avg(heap_mem_init) as avg_heap_mem_init, avg(heap_mem_max) as avg_heap_mem_max, avg(heap_mem_used) as avg_heap_mem_used, avg(non_heap_mem_committed) as avg_non_heap_mem_committed, avg(non_heap_mem_init) as avg_non_heap_mem_init, avg(non_heap_mem_max) as avg_non_heap_mem_max, avg(non_heap_mem_used) as avg_non_heap_mem_used, avg(processCpuTime) as avg_processCpuTime, avg(ps_eden_space_committed) as avg_ps_eden_space_committed, avg(ps_eden_space_init) as avg_ps_eden_space_init, avg(ps_eden_space_max) as avg_ps_eden_space_max, avg(ps_eden_space_used) as avg_ps_eden_space_used, avg(ps_perm_gen_committed) as avg_ps_perm_gen_committed, avg(ps_perm_gen_init) as avg_ps_perm_gen_init, avg(ps_perm_gen_max) as avg_ps_perm_gen_max, avg(ps_perm_gen_used) as avg_ps_perm_gen_used, year(from_unixtime(cast(payload_timestamp/1000 as BIGINT),'yyyy-MM-dd HH:mm:ss.SSS' )) as year, month(from_unixtime(cast(payload_timestamp/1000 as BIGINT),'yyyy-MM-dd HH:mm:ss.SSS' )) as month,day(from_unixtime(cast(payload_timestamp/1000 as BIGINT),'yyyy-MM-dd HH:mm:ss.SSS' )) as day,hour(from_unixtime(cast(payload_timestamp/1000 as BIGINT),'yyyy-MM-dd HH:mm:ss.SSS' )) as hour, minute(from_unixtime(cast(payload_timestamp/1000 as BIGINT),'yyyy-MM-dd HH:mm:ss.SSS' )) as minute,concat(substring(from_unixtime(cast(payload_timestamp/1000 as BIGINT), 'yyyy-MM-dd HH:mm:ss'),0,16),':00') as time from mappingJmxDataTable group by host,year(from_unixtime(cast(payload_timestamp/1000 as BIGINT),'yyyy-MM-dd HH:mm:ss.SSS' )), month(from_unixtime(cast(payload_timestamp/1000 as BIGINT),'yyyy-MM-dd HH:mm:ss.SSS' )),day(from_unixtime(cast(payload_timestamp/1000 as BIGINT),'yyyy-MM-dd HH:mm:ss.SSS' )),hour(from_unixtime(cast(payload_timestamp/1000 as BIGINT),'yyyy-MM-dd HH:mm:ss.SSS' )),minute(from_unixtime(cast(payload_timestamp/1000 as BIGINT),'yyyy-MM-dd HH:mm:ss.SSS' )),substring(from_unixtime(cast(payload_timestamp/1000 as BIGINT), 'yyyy-MM-dd HH:mm:ss'),0,16);

CREATE EXTERNAL TABLE IF NOT EXISTS JmxStatsPerMinuteDataFetcher (host STRING, avg_heap_mem_committed BIGINT, avg_heap_mem_init BIGINT, avg_heap_mem_max BIGINT, avg_heap_mem_used BIGINT, avg_non_heap_mem_committed BIGINT, avg_non_heap_mem_init BIGINT, avg_non_heap_mem_max BIGINT, avg_non_heap_mem_used BIGINT, avg_processCpuTime BIGINT, avg_ps_eden_space_committed BIGINT, avg_ps_eden_space_init BIGINT, avg_ps_eden_space_max BIGINT, avg_ps_eden_space_used BIGINT, avg_ps_perm_gen_committed BIGINT, avg_ps_perm_gen_init BIGINT, avg_ps_perm_gen_max BIGINT, avg_ps_perm_gen_used BIGINT, year SMALLINT, month SMALLINT, day SMALLINT, hour SMALLINT, minute SMALLINT, time STRING)
STORED BY 'org.wso2.carbon.hadoop.hive.jdbc.storage.JDBCStorageHandler' TBLPROPERTIES ( 
'wso2.carbon.datasource.name'='WSO2BAM_DATASOURCE',
'mapred.jdbc.input.table.name' = 'JMX_SUMMARY_PER_MINUTE' );

CREATE EXTERNAL TABLE IF NOT EXISTS JmxStatsPerHour (host STRING, avg_heap_mem_committed BIGINT, avg_heap_mem_init BIGINT, avg_heap_mem_max BIGINT, avg_heap_mem_used BIGINT, avg_non_heap_mem_committed BIGINT, avg_non_heap_mem_init BIGINT, avg_non_heap_mem_max BIGINT, avg_non_heap_mem_used BIGINT, avg_processCpuTime BIGINT, avg_ps_eden_space_committed BIGINT, avg_ps_eden_space_init BIGINT, avg_ps_eden_space_max BIGINT, avg_ps_eden_space_used BIGINT, avg_ps_perm_gen_committed BIGINT, avg_ps_perm_gen_init BIGINT, avg_ps_perm_gen_max BIGINT, avg_ps_perm_gen_used BIGINT, year SMALLINT, month SMALLINT, day SMALLINT, hour SMALLINT, time STRING)
STORED BY 'org.wso2.carbon.hadoop.hive.jdbc.storage.JDBCStorageHandler' TBLPROPERTIES ( 
'wso2.carbon.datasource.name'='WSO2BAM_DATASOURCE',
'hive.jdbc.update.on.duplicate' = 'true',
'hive.jdbc.primary.key.fields' = 'year,month,day,hour',
'hive.jdbc.table.create.query' = 'CREATE TABLE JMX_SUMMARY_PER_HOUR ( host VARCHAR(100) NOT NULL, avg_heap_mem_committed BIGINT, avg_heap_mem_init BIGINT, avg_heap_mem_max BIGINT, avg_heap_mem_used BIGINT, avg_non_heap_mem_committed BIGINT, avg_non_heap_mem_init BIGINT, avg_non_heap_mem_max BIGINT, avg_non_heap_mem_used BIGINT, avg_processCpuTime BIGINT, avg_ps_eden_space_committed BIGINT, avg_ps_eden_space_init BIGINT, avg_ps_eden_space_max BIGINT, avg_ps_eden_space_used BIGINT, avg_ps_perm_gen_committed BIGINT, avg_ps_perm_gen_init BIGINT, avg_ps_perm_gen_max BIGINT, avg_ps_perm_gen_used BIGINT, year SMALLINT, month SMALLINT, day SMALLINT, hour SMALLINT, time VARCHAR(30))' );

insert overwrite table JmxStatsPerHour select host, avg(avg_heap_mem_committed) as avg_heap_mem_committed, avg(avg_heap_mem_init) as avg_heap_mem_init, avg(avg_heap_mem_max) as avg_heap_mem_max, avg(avg_heap_mem_used) as avg_heap_mem_used, avg(avg_non_heap_mem_committed) as avg_non_heap_mem_committed, avg(avg_non_heap_mem_init) as avg_non_heap_mem_init, avg(avg_non_heap_mem_max) as avg_non_heap_mem_max, avg(avg_non_heap_mem_used) as avg_non_heap_mem_used, avg(avg_processCpuTime) as avg_processCpuTime, avg(avg_ps_eden_space_committed) as avg_ps_eden_space_committed, avg(avg_ps_eden_space_init) as avg_ps_eden_space_init, avg(avg_ps_eden_space_max) as avg_ps_eden_space_max, avg(avg_ps_eden_space_used) as avg_ps_eden_space_used, avg(avg_ps_perm_gen_committed) as avg_ps_perm_gen_committed, avg(avg_ps_perm_gen_init) as avg_ps_perm_gen_init, avg(avg_ps_perm_gen_max) as avg_ps_perm_gen_max, avg(avg_ps_perm_gen_used) as avg_ps_perm_gen_used, year, month, day, hour, concat(substr(time,0,13),':00:00') as time from JmxStatsPerMinuteDataFetcher group by host,year,month,day,hour,substr(time,0,13);


CREATE EXTERNAL TABLE IF NOT EXISTS JmxStatsPerHourDataFetcher (host STRING, avg_heap_mem_committed BIGINT, avg_heap_mem_init BIGINT, avg_heap_mem_max BIGINT, avg_heap_mem_used BIGINT, avg_non_heap_mem_committed BIGINT, avg_non_heap_mem_init BIGINT, avg_non_heap_mem_max BIGINT, avg_non_heap_mem_used BIGINT, avg_processCpuTime BIGINT, avg_ps_eden_space_committed BIGINT, avg_ps_eden_space_init BIGINT, avg_ps_eden_space_max BIGINT, avg_ps_eden_space_used BIGINT, avg_ps_perm_gen_committed BIGINT, avg_ps_perm_gen_init BIGINT, avg_ps_perm_gen_max BIGINT, avg_ps_perm_gen_used BIGINT, year SMALLINT, month SMALLINT, day SMALLINT, hour SMALLINT, time STRING)
STORED BY 'org.wso2.carbon.hadoop.hive.jdbc.storage.JDBCStorageHandler' TBLPROPERTIES ( 
'wso2.carbon.datasource.name'='WSO2BAM_DATASOURCE',
'mapred.jdbc.input.table.name' = 'JMX_SUMMARY_PER_HOUR'  );

CREATE EXTERNAL TABLE IF NOT EXISTS JmxStatsPerDay (host STRING, avg_heap_mem_committed BIGINT, avg_heap_mem_init BIGINT, avg_heap_mem_max BIGINT, avg_heap_mem_used BIGINT, avg_non_heap_mem_committed BIGINT, avg_non_heap_mem_init BIGINT, avg_non_heap_mem_max BIGINT, avg_non_heap_mem_used BIGINT, avg_processCpuTime BIGINT, avg_ps_eden_space_committed BIGINT, avg_ps_eden_space_init BIGINT, avg_ps_eden_space_max BIGINT, avg_ps_eden_space_used BIGINT, avg_ps_perm_gen_committed BIGINT, avg_ps_perm_gen_init BIGINT, avg_ps_perm_gen_max BIGINT, avg_ps_perm_gen_used BIGINT, year SMALLINT, month SMALLINT, day SMALLINT, time STRING)
STORED BY 'org.wso2.carbon.hadoop.hive.jdbc.storage.JDBCStorageHandler' TBLPROPERTIES ( 
'wso2.carbon.datasource.name'='WSO2BAM_DATASOURCE',
'hive.jdbc.update.on.duplicate' = 'true',
'hive.jdbc.primary.key.fields' = 'year,month,day',
'hive.jdbc.table.create.query' = 'CREATE TABLE JMX_SUMMARY_PER_DAY ( host VARCHAR(100) NOT NULL, avg_heap_mem_committed BIGINT, avg_heap_mem_init BIGINT, avg_heap_mem_max BIGINT, avg_heap_mem_used BIGINT, avg_non_heap_mem_committed BIGINT, avg_non_heap_mem_init BIGINT, avg_non_heap_mem_max BIGINT, avg_non_heap_mem_used BIGINT, avg_processCpuTime BIGINT, avg_ps_eden_space_committed BIGINT, avg_ps_eden_space_init BIGINT, avg_ps_eden_space_max BIGINT, avg_ps_eden_space_used BIGINT, avg_ps_perm_gen_committed BIGINT, avg_ps_perm_gen_init BIGINT, avg_ps_perm_gen_max BIGINT, avg_ps_perm_gen_used BIGINT, year SMALLINT, month SMALLINT, day SMALLINT, time VARCHAR(30))' );

insert overwrite table JmxStatsPerDay select host, avg(avg_heap_mem_committed) as avg_heap_mem_committed, avg(avg_heap_mem_init) as avg_heap_mem_init, avg(avg_heap_mem_max) as avg_heap_mem_max, avg(avg_heap_mem_used) as avg_heap_mem_used, avg(avg_non_heap_mem_committed) as avg_non_heap_mem_committed, avg(avg_non_heap_mem_init) as avg_non_heap_mem_init, avg(avg_non_heap_mem_max) as avg_non_heap_mem_max, avg(avg_non_heap_mem_used) as avg_non_heap_mem_used, avg(avg_processCpuTime) as avg_processCpuTime, avg(avg_ps_eden_space_committed) as avg_ps_eden_space_committed, avg(avg_ps_eden_space_init) as avg_ps_eden_space_init, avg(avg_ps_eden_space_max) as avg_ps_eden_space_max, avg(avg_ps_eden_space_used) as avg_ps_eden_space_used, avg(avg_ps_perm_gen_committed) as avg_ps_perm_gen_committed, avg(avg_ps_perm_gen_init) as avg_ps_perm_gen_init, avg(avg_ps_perm_gen_max) as avg_ps_perm_gen_max, avg(avg_ps_perm_gen_used) as avg_ps_perm_gen_used, year, month, day, substr(time,0,10) as time from JmxStatsPerHourDataFetcher group by host,year,month,day,substr(time,0,10);
